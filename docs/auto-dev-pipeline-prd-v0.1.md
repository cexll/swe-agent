# PRDï¼šé—­ç¯ Agent å·¥ä½œæµ â€”â€” ä»éœ€æ±‚æ¾„æ¸…åˆ°ä»£ç äº¤ä»˜

- ç‰ˆæœ¬ï¼š0.2
- Ownerï¼šswe-agentï¼ˆæœ¬é¡¹ç›®ï¼‰
- çŠ¶æ€ï¼šè‰æ¡ˆï¼ˆå¾…è¯„å®¡ï¼‰
- æ›´æ–°æ—¥æœŸï¼š2025-10-13

## èƒŒæ™¯

### æ ¸å¿ƒç—›ç‚¹
- ç»´æŠ¤è€…åœ¨ Issue ä¸­æå‡ºéœ€æ±‚åï¼Œäººå·¥æ²Ÿé€šã€æ‹†åˆ†ã€å®ç°ã€è¯„å®¡çš„**å¾€è¿”æˆæœ¬é«˜ï¼Œä¸”è´¨é‡ä¸ç¨³å®š**ã€‚
- AI ç›´æ¥æ‰§è¡Œä»£ç å¯èƒ½å› **ç¼ºå°‘ä»“åº“ä¸Šä¸‹æ–‡**å¯¼è‡´å®ç°åç¦»é¢„æœŸï¼Œéœ€è¦å¤šè½®è¿”å·¥ã€‚
- è‡ªåŠ¨åˆ›å»º PR å¯èƒ½äº§ç”Ÿ**åƒåœ¾ PR**ï¼Œäººå·¥å†³ç­–ç‚¹ç¼ºå¤±ã€‚

### ç°æœ‰èƒ½åŠ›
- æœ¬é¡¹ç›®å·²æœ‰ Webhookã€ä»»åŠ¡é˜Ÿåˆ—ã€æ‰§è¡Œå™¨ã€è¯„è®ºè¿½è¸ªç­‰èƒ½åŠ›ã€‚
- å·²æ”¯æŒ `issue_comment` å’Œ `pull_request_review_comment` äº‹ä»¶è§¦å‘ã€‚
- å·²æ”¯æŒæ¨é€åˆ°ç°æœ‰ PR åˆ†æ”¯ï¼ˆé¿å…é‡å¤ PRï¼‰ã€‚

### å‚è€ƒæ¡ˆä¾‹
- https://github.com/goplus/xgo/issues/2449ï¼ˆéœ€æ±‚æ¾„æ¸…æ¡ˆä¾‹ï¼‰
- https://github.com/goplus/xgo/issues/2461
- https://github.com/goplus/xgo/pull/2471ï¼ˆä»£ç å®ç°æ¡ˆä¾‹ï¼‰
- https://github.com/goplus/xgo/pull/2460
- https://github.com/goplus/xgo/pull/2456

## ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡ï¼šæ‰“é€ **äººç±»å‚ä¸çš„é—­ç¯ Agent**
- **Stage 0ï¼šéœ€æ±‚æ¾„æ¸…** â†’ AI åˆ†æä»“åº“ï¼Œç”Ÿæˆæ¾„æ¸…é—®é¢˜ï¼Œç”¨æˆ·å›ç­”ç¡®è®¤ã€‚
- **Stage 1ï¼šPRD ç”Ÿæˆ** â†’ åŸºäºæ¾„æ¸…ç»“æœç”Ÿæˆç»“æ„åŒ– PRDï¼Œç”¨æˆ·ç¡®è®¤åè¿›å…¥å¼€å‘ã€‚
- **Stage 2ï¼šä»£ç å¼€å‘** â†’ æŒ‰ PRD å®æ–½ï¼Œæ¨é€åˆ°åˆ†æ”¯ï¼Œ**ä¸è‡ªåŠ¨åˆ›å»º PR**ã€‚
- **Stage 3ï¼šCode Review**ï¼ˆå¯é€‰ï¼‰â†’ æŒ‰éœ€è§¦å‘ä»£ç å®¡æŸ¥ï¼ŒèŠ‚çœæˆæœ¬ã€‚
- **Stage 4ï¼šä¿®å¤è¿­ä»£** â†’ PR å®¡æŸ¥æ„è§è§¦å‘ä¿®å¤ï¼Œåœ¨ç°æœ‰åˆ†æ”¯æ›´æ–°ã€‚

### è®¾è®¡åŸåˆ™
1. **äººç±»å†³ç­–ç‚¹**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½éœ€è¦äººå·¥è§¦å‘ï¼Œé¿å…å¤±æ§ã€‚
2. **å®Œæ•´ä¸Šä¸‹æ–‡**ï¼šæ¯æ¬¡è§¦å‘éƒ½è·å– Issue å…¨éƒ¨è¯„è®ºå†å²ã€‚
3. **æˆæœ¬å¯æ§**ï¼šCode Review å¯é€‰ï¼Œä¿®å¤æ¬¡æ•°æœ‰ä¸Šé™ã€‚
4. **è´¨é‡ä¼˜å…ˆ**ï¼šä¸è‡ªåŠ¨åˆ›å»º PRï¼Œäººå·¥å®¡æ ¸åˆ†æ”¯å†…å®¹åå†åˆ›å»ºã€‚

## éç›®æ ‡
- ä¸æ›¿ä»£äººç±»æœ€ç»ˆå®¡æ ¸ä¸åˆå¹¶æƒé™ã€‚
- ä¸å¯¹é«˜é£é™©æ“ä½œï¼ˆå¤§è§„æ¨¡é‡æ„/æœªçŸ¥è„šæœ¬æ‰§è¡Œï¼‰åšè‡ªåŠ¨åŒ–å†³ç­–ã€‚
- ä¸æ‰¿è¯ºè·¨è¯­è¨€/è·¨ç”Ÿæ€çš„ä¸€é”®æ„å»ºä¸å¤æ‚æµ‹è¯•çŸ©é˜µé€‚é…ï¼ˆåç»­å¢é‡æ”¯æŒï¼‰ã€‚

## è§¦å‘ä¸è§’è‰²

### è§¦å‘è€…æƒé™
- **Issue ä½œè€…/Assignee**ï¼šå¯è§¦å‘æ‰€æœ‰é˜¶æ®µï¼ˆ/clarify, /prd, /code, /code-reviewï¼‰
- **ä»“åº“ Owner**ï¼šå®Œå…¨æ§åˆ¶æƒé™ï¼ˆå¯é…ç½®ç™½åå•ï¼‰
- **PR Reviewer**ï¼šå¯è§¦å‘ä¿®å¤ï¼ˆ/code fixï¼‰å’Œå®¡æŸ¥ï¼ˆ/code-reviewï¼‰

### åˆ†é˜¶æ®µè§¦å‘è¯ï¼ˆæ ¸å¿ƒåˆ›æ–°ï¼‰

| è§¦å‘è¯ | é˜¶æ®µ | è§¦å‘äº‹ä»¶ | è¯´æ˜ |
|--------|------|----------|------|
| `/clarify` | Stage 0 | `issue_comment` | éœ€æ±‚æ¾„æ¸…ï¼šç”Ÿæˆæ¾„æ¸…é—®é¢˜åˆ—è¡¨ |
| `/prd` | Stage 1 | `issue_comment` | ç”Ÿæˆ PRDï¼šåŸºäºæ¾„æ¸…ç»“æœç”Ÿæˆç»“æ„åŒ– PRD |
| `/code` | Stage 2 | `issue_comment` | ä»£ç å¼€å‘ï¼šæŒ‰ PRD å®æ–½ï¼Œæ¨é€åˆ°åˆ†æ”¯ï¼ˆ**ä¸åˆ›å»º PR**ï¼‰ |
| `/code-review` | Stage 3 | `issue_comment` æˆ– `pull_request` comment | ä»£ç å®¡æŸ¥ï¼ˆå¯é€‰ï¼‰ï¼šåˆ†æå˜æ›´æ–‡ä»¶ï¼Œç”Ÿæˆ Review æ„è§ |
| `/code fix [æ„è§]` | Stage 4 | `pull_request_review_comment` æˆ– comment | ä¿®å¤è¿­ä»£ï¼šåŸºäº Review æ„è§ä¿®å¤ä»£ç  |

**æ™ºèƒ½è§¦å‘æ¨¡å¼**ï¼ˆå¯é€‰ï¼Œæœªæ¥æ”¯æŒï¼‰ï¼š
- `/code` æ ¹æ®å½“å‰å·¥ä½œæµé˜¶æ®µè‡ªåŠ¨åˆ¤æ–­è¡Œä¸ºï¼š
  - é¦–æ¬¡è°ƒç”¨ â†’ è‡ªåŠ¨è¿›å…¥ `/clarify`
  - æ¾„æ¸…å®Œæˆ â†’ è‡ªåŠ¨è¿›å…¥ `/prd`
  - PRD ç¡®è®¤ â†’ è‡ªåŠ¨è¿›å…¥ä»£ç å¼€å‘
  - PR å·²åˆ›å»º â†’ è‡ªåŠ¨è¿›å…¥ä¿®å¤æ¨¡å¼

### äº‹ä»¶ç›‘å¬ï¼ˆWebhookï¼‰

| äº‹ä»¶ç±»å‹ | è§¦å‘æ¡ä»¶ | è¡Œä¸º |
|----------|----------|------|
| `issue_comment.created` | åŒ…å«è§¦å‘è¯ (/clarify, /prd, /code, /code-review) | æ ¹æ®è§¦å‘è¯æ‰§è¡Œå¯¹åº”é˜¶æ®µ |
| `pull_request_review_comment.created` | åŒ…å« `/code fix` | åœ¨ PR åˆ†æ”¯ä¸Šä¿®å¤ä»£ç  |
| `pull_request_review.submitted` | state=changes_requested **ä¸”** åŒ…å«è§¦å‘è¯ | è¯»å–å®¡æŸ¥æ„è§ï¼Œè§¦å‘ä¿®å¤ï¼ˆ**ä¸è‡ªåŠ¨è§¦å‘**ï¼Œéœ€è¦æ˜ç¡®æŒ‡ä»¤ï¼‰ |
| ~~`issues.opened`~~ | âŒ **ä¸æ”¯æŒè‡ªåŠ¨è§¦å‘** | éœ€è¦æ‰‹åŠ¨ `/clarify` å¯åŠ¨æµç¨‹ |

**é˜²æŠ–æœºåˆ¶**ï¼š
- å¿½ç•¥ Bot å‘å‡ºçš„è¯„è®ºï¼ˆ`sender.type == "Bot"`ï¼‰
- åŒä¸€è¯„è®º ID 12 å°æ—¶å†…å»é‡ï¼ˆå·²å®ç°ï¼š`commentDeduper`ï¼‰
- æŒ‰ `repo#number` ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…å¹¶å‘å†²çª

## ç«¯åˆ°ç«¯æµç¨‹ï¼š5 é˜¶æ®µé—­ç¯

### **Stage 0ï¼šéœ€æ±‚æ¾„æ¸…ï¼ˆ/clarifyï¼‰**

**è§¦å‘**ï¼šç”¨æˆ·åœ¨ Issue ä¸­å›å¤ `/clarify`

**Agent è¡Œä¸º**ï¼š
1. è¯»å– Issue å…¨æ–‡ï¼ˆæ ‡é¢˜ + æ­£æ–‡ + æ‰€æœ‰è¯„è®ºï¼‰
2. è¯»å–ä»“åº“ä¸Šä¸‹æ–‡ï¼š
   - README.mdï¼ˆé¡¹ç›®ç®€ä»‹ï¼‰
   - ä¸»è¦ç›®å½•ç»“æ„ï¼ˆ`ls -R | head -100`ï¼‰
   - å…³é”®é…ç½®æ–‡ä»¶ï¼ˆpackage.json, go.mod, Cargo.toml ç­‰ï¼‰
3. è°ƒç”¨ Provider ç”Ÿæˆæ¾„æ¸…é—®é¢˜åˆ—è¡¨ï¼ˆ5-10 ä¸ªé—®é¢˜ï¼‰
4. åœ¨ Issue è¯„è®ºä¸­å‘å¸ƒé—®é¢˜åˆ—è¡¨ï¼ˆMarkdown Checklist æ ¼å¼ï¼‰

**Prompt æ¨¡æ¿**ï¼š
```markdown
ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚åˆ†æä¸“å®¶ã€‚ç”¨æˆ·æå‡ºäº†ä»¥ä¸‹éœ€æ±‚ï¼š

ã€Issue æ ‡é¢˜ã€‘{issue.title}
ã€Issue æ­£æ–‡ã€‘{issue.body}
ã€ä»“åº“ä¿¡æ¯ã€‘
- é¡¹ç›®è¯­è¨€ï¼š{language}
- ä¸»è¦ç›®å½•ï¼š{directory_structure}
- README æ‘˜è¦ï¼š{readme_summary}

è¯·æå‡º 5-10 ä¸ªæ¾„æ¸…é—®é¢˜ï¼Œç¡®ä¿éœ€æ±‚æ¸…æ™°ã€‚é—®é¢˜ç±»å‹ï¼š
- åŠŸèƒ½è¾¹ç•Œï¼šè¿™ä¸ªåŠŸèƒ½æ˜¯å¦åŒ…æ‹¬ XXXï¼Ÿ
- æŠ€æœ¯çº¦æŸï¼šæ˜¯å¦éœ€è¦å…¼å®¹ XXX ç‰ˆæœ¬ï¼Ÿ
- éªŒæ”¶æ ‡å‡†ï¼šå¦‚ä½•åˆ¤æ–­åŠŸèƒ½å®Œæˆï¼Ÿ
- ä¾èµ–å…³ç³»ï¼šæ˜¯å¦ä¾èµ–å…¶ä»–æœªå®Œæˆçš„åŠŸèƒ½ï¼Ÿ

è¾“å‡ºæ ¼å¼ï¼ˆMarkdown Checklistï¼‰ï¼š
- [ ] **é—®é¢˜ 1**ï¼šXXX
- [ ] **é—®é¢˜ 2**ï¼šXXX
```

**ç”¨æˆ·å“åº”**ï¼š
- ç”¨æˆ·åœ¨é—®é¢˜ä¸‹æ–¹å›å¤ç­”æ¡ˆï¼Œæˆ–ç›´æ¥ç¼–è¾‘ Checklist
- å›å¤ `/prd` è¡¨ç¤ºæ¾„æ¸…å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ

**çŠ¶æ€å­˜å‚¨**ï¼š
```go
// taskstore.WorkflowState
Stage: "clarify"
Clarifications: []Clarification{
    {Question: "é—®é¢˜ 1", Answer: "ç­”æ¡ˆ 1", Resolved: true},
    {Question: "é—®é¢˜ 2", Answer: "", Resolved: false},
}
```

---

### **Stage 1ï¼šPRD ç”Ÿæˆï¼ˆ/prdï¼‰**

**è§¦å‘**ï¼šç”¨æˆ·å›å¤ `/prd`ï¼ˆè¡¨ç¤ºæ¾„æ¸…å®Œæˆï¼‰

**Agent è¡Œä¸º**ï¼š
1. è¯»å– Issue å…¨æ–‡ + æ¾„æ¸…é—®ç­”å†å²
2. è°ƒç”¨ Provider ç”Ÿæˆç»“æ„åŒ– PRD
3. åœ¨ Issue è¯„è®ºä¸­å‘å¸ƒ PRDï¼ˆ**ä¸è½ç›˜æ–‡ä»¶**ï¼ŒåˆæœŸï¼‰

**PRD æ ¼å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼š
```markdown
## PRDï¼š{issue.title}

### èƒŒæ™¯
{åŸºäº Issue æ­£æ–‡å’Œæ¾„æ¸…ç»“æœæç‚¼}

### ç›®æ ‡
- æ ¸å¿ƒåŠŸèƒ½ 1
- æ ¸å¿ƒåŠŸèƒ½ 2

### éç›®æ ‡
- ä¸åŒ…å« XXX
- ä¸æ”¯æŒ XXX

### æŠ€æœ¯æ–¹æ¡ˆ
{å®ç°æ€è·¯ï¼ŒåŒ…å«å…³é”®æ–‡ä»¶å’Œä¿®æ”¹ç‚¹}

### éªŒæ”¶æ ‡å‡†
- [ ] åŠŸèƒ½ 1 å®Œæˆ
- [ ] æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£æ›´æ–°

### æ–‡ä»¶å˜æ›´é¢„ä¼°
- ä¿®æ”¹ï¼šinternal/webhook/handler.goï¼ˆæ–°å¢ /clarify è§¦å‘é€»è¾‘ï¼‰
- æ–°å¢ï¼šinternal/workflow/clarify.goï¼ˆæ¾„æ¸…é—®é¢˜ç”Ÿæˆï¼‰
- æµ‹è¯•ï¼šinternal/workflow/clarify_test.go

### é£é™©è¯„ä¼°
- å¤æ‚åº¦ï¼šä¸­ç­‰ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰
- ç ´åæ€§ï¼šä½ï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰
- ä¾èµ–ï¼šéœ€è¦æ‰©å±• webhook/types.go
```

**å¤§éœ€æ±‚æ‹†åˆ†åˆ¤æ–­**ï¼š
- å¦‚æœé¢„ä¼°æ–‡ä»¶å˜æ›´ > 8 ä¸ª â†’ æç¤ºç”¨æˆ·æ‹†åˆ†ä¸ºå¤šä¸ª Issue
- å¦‚æœå¤æ‚åº¦é«˜ â†’ å»ºè®®åˆ†å¤šä¸ª PR æäº¤

**ç”¨æˆ·å“åº”**ï¼š
- å›å¤"ç¡®è®¤"æˆ– `/code` â†’ è¿›å…¥å¼€å‘é˜¶æ®µ
- å›å¤ä¿®æ”¹æ„è§ â†’ Agent æ›´æ–° PRDï¼ˆé‡æ–°è°ƒç”¨ Providerï¼‰

**çŠ¶æ€å­˜å‚¨**ï¼š
```go
Stage: "prd"
PRD: "{ç”Ÿæˆçš„ PRD æ–‡æ¡£å†…å®¹}"
```

---

### **Stage 2ï¼šä»£ç å¼€å‘ï¼ˆ/codeï¼‰**

**è§¦å‘**ï¼šç”¨æˆ·å›å¤ `/code`

**Agent è¡Œä¸º**ï¼š
1. è¯»å– Issue å…¨æ–‡ + æ¾„æ¸… + PRDï¼ˆ**å®Œæ•´ä¸Šä¸‹æ–‡**ï¼‰
2. Clone ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
3. è°ƒç”¨ Provider ç”Ÿæˆä»£ç å˜æ›´
4. æäº¤åˆ°åˆ†æ”¯ï¼ˆ`pilot/issue-{number}-{timestamp}`ï¼‰
5. æ¨é€åˆ° GitHubï¼ˆ**ä¸åˆ›å»º PR**ï¼‰
6. åœ¨è¯„è®ºä¸­è¿”å›ï¼š
   - åˆ†æ”¯é“¾æ¥ï¼š`https://github.com/{repo}/tree/{branch}`
   - **æ‰‹åŠ¨åˆ›å»º PR é“¾æ¥**ï¼š`https://github.com/{repo}/compare/main...{branch}`
   - å˜æ›´æ–‡ä»¶åˆ—è¡¨
   - æˆæœ¬

**å…³é”®æ”¹åŠ¨**ï¼ˆç›¸æ¯”å½“å‰å®ç°ï¼‰ï¼š
```go
// executor/task.go:352ï¼ˆå½“å‰ä¼šè‡ªåŠ¨åˆ›å»º PRï¼‰
// æ”¹ä¸ºï¼šåªè¿”å›åˆ†æ”¯é“¾æ¥å’Œæ‰‹åŠ¨åˆ›å»º PR çš„é“¾æ¥

branchURL := fmt.Sprintf("https://github.com/%s/tree/%s", task.Repo, branchName)
createPRURL := fmt.Sprintf("https://github.com/%s/compare/%s...%s?expand=1&title=%s", 
    task.Repo, task.Branch, branchName, url.QueryEscape(task.IssueTitle))

tracker.SetCompleted(result.Summary, files, cost)
tracker.SetBranch(branchName, branchURL)
tracker.SetMessage("ğŸ“ ä»£ç å·²æ¨é€åˆ°åˆ†æ”¯")
tracker.SetMessage(fmt.Sprintf("ğŸ”— æ‰‹åŠ¨åˆ›å»º PRï¼š%s", createPRURL))
```

**ç”¨æˆ·å†³ç­–**ï¼š
- æ»¡æ„ â†’ æ‰‹åŠ¨ç‚¹å‡»é“¾æ¥åˆ›å»º PR
- ä¸æ»¡æ„ â†’ å›å¤ä¿®æ”¹æ„è§ï¼ŒAgent åœ¨åŒä¸€åˆ†æ”¯ç»§ç»­ä¿®å¤ï¼ˆå¤ç”¨ `/code fix`ï¼‰

**çŠ¶æ€å­˜å‚¨**ï¼š
```go
Stage: "coding"
BranchName: "pilot/issue-123-1234567890"
FilesChanged: []string{"handler.go", "clarify.go"}
```

---

### **Stage 3ï¼šCode Reviewï¼ˆ/code-reviewï¼Œå¯é€‰ï¼‰**

**è§¦å‘**ï¼šç”¨æˆ·åœ¨ PR è¯„è®ºä¸­å›å¤ `/code-review`

**Agent è¡Œä¸º**ï¼š
1. è¯»å– PR çš„ `git diff`ï¼ˆå˜æ›´å†…å®¹ï¼‰
2. è¯»å– PRDï¼ˆå®¡æŸ¥æ ‡å‡†ï¼‰
3. è°ƒç”¨ Provider ç”Ÿæˆ Review æ„è§
4. åœ¨ PR ä¸­å‘å¸ƒ Review è¯„è®ºï¼ˆæ”¯æŒè¡Œå†…è¯„è®ºï¼‰

**Review Prompt**ï¼š
```markdown
ä½ æ˜¯ä¸€ä¸ªä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼š

ã€PRD æ‘˜è¦ã€‘{prd_summary}
ã€å˜æ›´æ–‡ä»¶ã€‘
{git diff output}

ã€å®¡æŸ¥æ ‡å‡†ã€‘
- ä»£ç é£æ ¼æ˜¯å¦ç¬¦åˆé¡¹ç›®è§„èŒƒï¼ˆå‚è€ƒç°æœ‰ä»£ç ï¼‰
- æ˜¯å¦æœ‰æ½œåœ¨çš„ Bugï¼ˆè¾¹ç•Œæ¡ä»¶ã€é”™è¯¯å¤„ç†ï¼‰
- æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ï¼ˆO(n^2) å¾ªç¯ã€å†…å­˜æ³„æ¼ï¼‰
- æ˜¯å¦éœ€è¦è¡¥å……æµ‹è¯•
- æ˜¯å¦ç¬¦åˆ PRD è¦æ±‚

è¯·è¾“å‡º Review æ„è§ï¼ˆGitHub Review æ ¼å¼ï¼‰ã€‚
```

**è¾“å‡ºæ ¼å¼**ï¼š
```markdown
## ğŸ” Code Review ç»“æœ

### âœ… é€šè¿‡çš„æ£€æŸ¥
- ä»£ç é£æ ¼ç¬¦åˆé¡¹ç›®è§„èŒƒ
- æ— æ˜æ˜¾ Bug
- ç¬¦åˆ PRD è¦æ±‚

### âš ï¸ éœ€è¦æ”¹è¿›
- `handler.go:132` ç¼ºå°‘é”™è¯¯å¤„ç†ï¼Œå»ºè®®åŠ  `if err != nil`
- `task.go:250` å‡½æ•°è¿‡é•¿ï¼ˆ150 è¡Œï¼‰ï¼Œå»ºè®®æ‹†åˆ†

### ğŸ“ å»ºè®®ï¼ˆå¯é€‰ï¼‰
- è¡¥å……å•å…ƒæµ‹è¯•è¦†ç›– `/clarify` è§¦å‘é€»è¾‘
- æ›´æ–° README æ–‡æ¡£

### ğŸ’° æˆæœ¬
- Review æˆæœ¬ï¼š$0.05
```

**ç”¨æˆ·å†³ç­–**ï¼š
- æ¥å— Review â†’ å›å¤ `/code fix` è§¦å‘ä¿®å¤
- å¿½ç•¥ Review â†’ ç›´æ¥ Merge PR

---

### **Stage 4ï¼šä¿®å¤è¿­ä»£ï¼ˆ/code fixï¼‰**

**è§¦å‘**ï¼š
1. PR Review æå‡ºé—®é¢˜ï¼Œç”¨æˆ·å›å¤ `/code fix`
2. æˆ–ï¼šç”¨æˆ·åœ¨ PR è¯„è®ºä¸­ç›´æ¥ `/code fix [å…·ä½“æ„è§]`

**Agent è¡Œä¸º**ï¼š
1. è¯»å– Review æ„è§ï¼ˆæˆ–ç”¨æˆ·è¯„è®ºï¼‰
2. è¯»å–å½“å‰ PR åˆ†æ”¯çš„ä»£ç 
3. è°ƒç”¨ Provider ç”Ÿæˆä¿®å¤ä»£ç 
4. åœ¨ **ç°æœ‰ PR åˆ†æ”¯** ä¸Šæäº¤æ–° commitï¼ˆ**ä¸åˆ›å»ºæ–° PR**ï¼‰
5. æ¨é€åˆ° GitHub
6. åœ¨ PR ä¸­è¯„è®ºä¿®å¤ç»“æœ

**å…³é”®å®ç°**ï¼ˆå·²æ”¯æŒï¼‰ï¼š
```go
// executor/task.go:308
if task.IsPR && task.PRState == "open" && task.PRBranch != "" {
    // PR is open â†’ push to existing PR branch
    branchName = task.PRBranch
    shouldCreateBranch = false
}
```

**ä¿®å¤æ¬¡æ•°é™åˆ¶**ï¼š
- å•ä¸ª PR æœ€å¤šè‡ªåŠ¨ä¿®å¤ **3 æ¬¡**
- è¶…è¿‡ 3 æ¬¡ â†’ æç¤ºéœ€è¦äººå·¥ä»‹å…¥

**çŠ¶æ€å­˜å‚¨**ï¼š
```go
Stage: "review"
FixAttempts: 2  // å·²ä¿®å¤ 2 æ¬¡
MaxFixAttempts: 3
```

---

### **Stage 5ï¼šå®Œæˆï¼ˆDoneï¼‰**

**è§¦å‘**ï¼šPR è¢« Merge

**Agent è¡Œä¸º**ï¼š
- æ›´æ–°å·¥ä½œæµçŠ¶æ€ï¼š`Stage: "done"`
- è®°å½•æŒ‡æ ‡ï¼šæ€»æˆæœ¬ã€æ€»è€—æ—¶ã€ä¿®å¤æ¬¡æ•°
- æ¸…ç†ä¸´æ—¶æ•°æ®

**æŒ‡æ ‡æ”¶é›†**ï¼š
```go
Metrics {
    TotalCost: 0.25,         // æ€»æˆæœ¬ï¼ˆç¾å…ƒï¼‰
    TotalTime: "2h 30m",     // ä» /clarify åˆ° PR Merge
    ClarifyRounds: 2,        // æ¾„æ¸…è½®æ¬¡
    PRDIterations: 1,        // PRD ä¿®æ”¹æ¬¡æ•°
    FixAttempts: 2,          // ä»£ç ä¿®å¤æ¬¡æ•°
    FilesChanged: 8,         // å˜æ›´æ–‡ä»¶æ•°
}
```

## è¯¦ç»†éœ€æ±‚

### å·¥ä½œæµçŠ¶æ€è¿½è¸ª

**æ•°æ®ç»“æ„**ï¼ˆæ–°å¢ï¼‰ï¼š
```go
// taskstore/workflow.goï¼ˆæ–°æ–‡ä»¶ï¼‰
type WorkflowState struct {
    IssueNumber    int
    Repo           string
    Stage          string // "clarify", "prd", "coding", "review", "done"
    
    // æ¾„æ¸…å†å²
    Clarifications []Clarification
    
    // PRD å†…å®¹
    PRD            string
    
    // ä»£ç å˜æ›´
    BranchName     string
    FilesChanged   []string
    
    // ä¿®å¤å†å²
    FixAttempts    int
    MaxFixAttempts int
    
    // æˆæœ¬è¿½è¸ª
    TotalCost      float64
    
    // æ—¶é—´è¿½è¸ª
    CreatedAt      time.Time
    UpdatedAt      time.Time
}

type Clarification struct {
    Question  string    // Agent æå‡ºçš„é—®é¢˜
    Answer    string    // ç”¨æˆ·çš„å›ç­”ï¼ˆå¯ä¸ºç©ºï¼‰
    Timestamp time.Time
}

// å­˜å‚¨æ¥å£
func (s *Store) GetWorkflow(repo string, issueNumber int) (*WorkflowState, error)
func (s *Store) UpdateWorkflow(state *WorkflowState) error
```

**å­˜å‚¨æ–¹æ¡ˆ**ï¼š
- **åˆæœŸ**ï¼šå†…å­˜å­˜å‚¨ï¼ˆ`map[string]*WorkflowState`ï¼Œkey=`{repo}#{issue_number}`ï¼‰
- **é•¿æœŸ**ï¼šè¿ç§»åˆ°æ•°æ®åº“ï¼ˆå¤ç”¨ `taskstore.Store`ï¼‰

### å®Œæ•´ä¸Šä¸‹æ–‡è·å–

**é—®é¢˜**ï¼šå½“å‰ `composeDiscussionSection()` åªè·å–è¯„è®ºï¼Œä¸åŒ…å«å·¥ä½œæµå†å²

**æ”¹è¿›**ï¼ˆexecutor/task.go:550ï¼‰ï¼š
```go
func (e *Executor) composeFullContext(task *webhook.Task, token string) string {
    // 1. è·å– Issue æ‰€æœ‰è¯„è®º
    issueComments := e.ghClient.ListIssueComments(task.Repo, task.Number, token)
    
    // 2. è·å–å·¥ä½œæµçŠ¶æ€
    workflow := e.workflowStore.GetWorkflow(task.Repo, task.Number)
    
    // 3. ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡
    var context strings.Builder
    
    // Issue æ­£æ–‡
    context.WriteString("# Issue: " + task.IssueTitle + "\n\n")
    context.WriteString(task.IssueBody + "\n\n")
    
    // æ¾„æ¸…å†å²
    if len(workflow.Clarifications) > 0 {
        context.WriteString("## éœ€æ±‚æ¾„æ¸…\n\n")
        for _, c := range workflow.Clarifications {
            context.WriteString(fmt.Sprintf("Q: %s\nA: %s\n\n", c.Question, c.Answer))
        }
    }
    
    // PRD
    if workflow.PRD != "" {
        context.WriteString("## PRD\n\n")
        context.WriteString(workflow.PRD + "\n\n")
    }
    
    // è¯„è®ºå†å²
    context.WriteString("## è®¨è®ºå†å²\n\n")
    context.WriteString(formatDiscussion(issueComments, nil))
    
    return context.String()
}
```

### è§¦å‘è¯è§£æ

**æ–°å¢å‡½æ•°**ï¼ˆwebhook/handler.goï¼‰ï¼š
```go
// parseTriggerCommand è§£æè§¦å‘è¯å’Œå‚æ•°
func (h *Handler) parseTriggerCommand(body string) (action string, content string, found bool) {
    triggers := []string{"/clarify", "/prd", "/code-review", "/code"}
    
    for _, trigger := range triggers {
        if idx := strings.Index(body, trigger); idx != -1 {
            action = strings.TrimPrefix(trigger, "/")
            content = strings.TrimSpace(body[idx+len(trigger):])
            found = true
            return
        }
    }
    
    return "", "", false
}

// determineWorkflowAction æ ¹æ®è§¦å‘è¯å’Œå½“å‰é˜¶æ®µå†³å®šè¡Œä¸º
func (h *Handler) determineWorkflowAction(task *Task, action string) string {
    // æ˜¾å¼è§¦å‘è¯ä¼˜å…ˆ
    if action != "" {
        return action
    }
    
    // æœªæ¥ï¼šæ™ºèƒ½è§¦å‘æ¨¡å¼ï¼ˆæ ¹æ®å½“å‰ Stage è‡ªåŠ¨åˆ¤æ–­ï¼‰
    workflow := h.workflowStore.GetWorkflow(task.Repo, task.Number)
    switch workflow.Stage {
    case "":
        return "clarify" // é¦–æ¬¡è§¦å‘ â†’ æ¾„æ¸…
    case "clarify":
        return "prd"     // æ¾„æ¸…å®Œæˆ â†’ ç”Ÿæˆ PRD
    case "prd":
        return "coding"  // PRD ç¡®è®¤ â†’ å¼€å‘ä»£ç 
    default:
        return "coding"  // é»˜è®¤è¡Œä¸º
    }
}
```

### Prompt æ¨¡æ¿ç®¡ç†

**æ–°å¢æ–‡ä»¶**ï¼š
```
internal/prompt/
â”œâ”€â”€ clarify.go      # éœ€æ±‚æ¾„æ¸… Prompt
â”œâ”€â”€ prd.go          # PRD ç”Ÿæˆ Prompt
â”œâ”€â”€ review.go       # Code Review Prompt
â””â”€â”€ manager.go      # Prompt æ¨¡æ¿ç®¡ç†å™¨ï¼ˆå·²å­˜åœ¨ï¼‰
```

**ç¤ºä¾‹**ï¼ˆinternal/prompt/clarify.goï¼‰ï¼š
```go
package prompt

func GenerateClarifyPrompt(issue Issue, repoContext RepoContext) string {
    return fmt.Sprintf(`ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚åˆ†æä¸“å®¶ã€‚ç”¨æˆ·æå‡ºäº†ä»¥ä¸‹éœ€æ±‚ï¼š

ã€Issue æ ‡é¢˜ã€‘%s
ã€Issue æ­£æ–‡ã€‘%s

ã€ä»“åº“ä¿¡æ¯ã€‘
- é¡¹ç›®è¯­è¨€ï¼š%s
- ä¸»è¦ç›®å½•ï¼š%s
- README æ‘˜è¦ï¼š%s

è¯·æå‡º 5-10 ä¸ªæ¾„æ¸…é—®é¢˜ï¼Œç¡®ä¿éœ€æ±‚æ¸…æ™°ã€‚é—®é¢˜ç±»å‹ï¼š
- åŠŸèƒ½è¾¹ç•Œï¼šè¿™ä¸ªåŠŸèƒ½æ˜¯å¦åŒ…æ‹¬ XXXï¼Ÿ
- æŠ€æœ¯çº¦æŸï¼šæ˜¯å¦éœ€è¦å…¼å®¹ XXX ç‰ˆæœ¬ï¼Ÿ
- éªŒæ”¶æ ‡å‡†ï¼šå¦‚ä½•åˆ¤æ–­åŠŸèƒ½å®Œæˆï¼Ÿ
- ä¾èµ–å…³ç³»ï¼šæ˜¯å¦ä¾èµ–å…¶ä»–æœªå®Œæˆçš„åŠŸèƒ½ï¼Ÿ

è¾“å‡ºæ ¼å¼ï¼ˆMarkdown Checklistï¼‰ï¼š
- [ ] **é—®é¢˜ 1**ï¼šXXX
- [ ] **é—®é¢˜ 2**ï¼šXXX
`, issue.Title, issue.Body, repoContext.Language, repoContext.Structure, repoContext.ReadmeSummary)
}
```

### PR åˆ›å»ºç­–ç•¥è°ƒæ•´

**å½“å‰ä»£ç **ï¼ˆexecutor/task.go:352ï¼‰ï¼š
```go
// è‡ªåŠ¨åˆ›å»º PR é“¾æ¥ï¼ˆcompare é¡µé¢ï¼‰
prURL, err := e.createPRLink(task.Repo, branchName, task.Branch, result.Summary)
```

**æ”¹ä¸º**ï¼š
```go
// ä¸åˆ›å»º PRï¼Œåªè¿”å›åˆ†æ”¯é“¾æ¥å’Œæ‰‹åŠ¨åˆ›å»º PR çš„é“¾æ¥
branchURL := fmt.Sprintf("https://github.com/%s/tree/%s", task.Repo, branchName)
createPRURL := fmt.Sprintf("https://github.com/%s/compare/%s...%s?expand=1&title=%s&body=%s", 
    task.Repo, 
    url.PathEscape(task.Branch), 
    url.PathEscape(branchName), 
    url.QueryEscape(task.IssueTitle),
    url.QueryEscape("Fixes #" + strconv.Itoa(task.Number)))

tracker.SetBranch(branchName, branchURL)
tracker.SetMessage("ğŸ“ ä»£ç å·²æ¨é€åˆ°åˆ†æ”¯")
tracker.SetMessage(fmt.Sprintf("ğŸ”— æ‰‹åŠ¨åˆ›å»º PRï¼š%s", createPRURL))
```

### ä¿®å¤æ¬¡æ•°é™åˆ¶

**æ–°å¢æ£€æŸ¥**ï¼ˆexecutor/task.goï¼‰ï¼š
```go
func (e *Executor) shouldAllowFix(task *webhook.Task) (bool, string) {
    workflow := e.workflowStore.GetWorkflow(task.Repo, task.Number)
    
    if workflow.FixAttempts >= workflow.MaxFixAttempts {
        return false, fmt.Sprintf(
            "å·²è¾¾åˆ°æœ€å¤§ä¿®å¤æ¬¡æ•°ï¼ˆ%d/%dï¼‰ï¼Œéœ€è¦äººå·¥ä»‹å…¥",
            workflow.FixAttempts,
            workflow.MaxFixAttempts,
        )
    }
    
    return true, ""
}

// åœ¨ Execute() ä¸­è°ƒç”¨
if task.IsPR && strings.Contains(task.Prompt, "/code fix") {
    if allowed, reason := e.shouldAllowFix(task); !allowed {
        return e.handleError(task, tracker, token, reason)
    }
}
```

## PRD æ¨¡æ¿ï¼ˆæœªæ¥è‡ªåŠ¨ç”Ÿæˆè‡³ `docs/prd/ISSUE-<number>.md`ï¼‰
- èƒŒæ™¯
- ç›®æ ‡ï¼ˆæˆåŠŸæ ‡å‡†/å¯é‡åŒ–æŒ‡æ ‡ï¼‰
- éç›®æ ‡
- ç”¨æˆ·æ•…äº‹ä¸éªŒæ”¶æ ‡å‡†ï¼ˆGiven/When/Thenï¼‰
- æ–¹æ¡ˆï¼ˆæ¶æ„/æ•°æ®ç»“æ„/äº‹ä»¶æ‰©å±•/Prompt ç­–ç•¥/æ‰§è¡Œæµç¨‹ï¼‰
- ä»»åŠ¡æ‹†è§£ï¼ˆå¼€å‘/æµ‹è¯•/æ–‡æ¡£/å›æ»šï¼‰
- æµ‹è¯•ç­–ç•¥ï¼ˆå•æµ‹/é›†æˆ/æ‰‹éªŒè¦ç‚¹ï¼‰
- é£é™©ï¼ˆè¯¯æ”¹/æƒé™/å›å½’/é…é¢ï¼‰ä¸ç¼“è§£
- é‡Œç¨‹ç¢‘ï¼ˆå‘¨ï¼‰ä¸è¿”å·¥é˜ˆå€¼
- é™„å½•ï¼ˆå‚è€ƒé“¾æ¥ã€æ ·ä¾‹ payloadï¼‰

## é…ç½®é¡¹

### æ ¸å¿ƒé…ç½®

```bash
# è§¦å‘è¯é…ç½®
TRIGGER_KEYWORD="@assistant"  # é»˜è®¤è§¦å‘è¯ï¼ˆå·²æ”¯æŒï¼‰

# å·¥ä½œæµé…ç½®ï¼ˆæ–°å¢ï¼‰
ENABLE_WORKFLOW_MODE=true     # æ˜¯å¦å¯ç”¨å¤šé˜¶æ®µå·¥ä½œæµ
DEFAULT_WORKFLOW_STAGE="clarify"  # é¦–æ¬¡è§¦å‘çš„é»˜è®¤é˜¶æ®µ

# ä¿®å¤é™åˆ¶ï¼ˆæ–°å¢ï¼‰
MAX_FIX_ATTEMPTS=3            # å•ä¸ª PR æœ€å¤šä¿®å¤æ¬¡æ•°

# PR åˆ›å»ºç­–ç•¥ï¼ˆæ–°å¢ï¼‰
AUTO_CREATE_PR=false          # æ˜¯å¦è‡ªåŠ¨åˆ›å»º PRï¼ˆé»˜è®¤å…³é—­ï¼‰
PR_DRAFT_MODE=false           # æ˜¯å¦åˆ›å»º Draft PR

# Code Review é…ç½®ï¼ˆæ–°å¢ï¼‰
ENABLE_AUTO_REVIEW=false      # æ˜¯å¦é»˜è®¤å¼€å¯ Code Review
REVIEW_STANDARDS="style,bug,performance,test"  # å®¡æŸ¥æ ‡å‡†ï¼ˆé€—å·åˆ†éš”ï¼‰

# æˆæœ¬æ§åˆ¶ï¼ˆæ–°å¢ï¼ŒP0ï¼‰
DAILY_CALL_LIMIT=100          # æ¯æ—¥ AI è°ƒç”¨ä¸Šé™
PER_ISSUE_COST_LIMIT=1.0      # å•ä¸ª Issue æˆæœ¬ä¸Šé™ï¼ˆç¾å…ƒï¼‰
COST_ALERT_THRESHOLD=0.5      # æˆæœ¬å‘Šè­¦é˜ˆå€¼ï¼ˆç¾å…ƒï¼‰

# Provider é…ç½®ï¼ˆå·²æ”¯æŒï¼‰
PROVIDER="claude"             # or "codex"
CLAUDE_API_KEY="sk-ant-xxx"
CLAUDE_MODEL="claude-3-5-sonnet-20241022"

# è°ƒåº¦é…ç½®ï¼ˆå·²æ”¯æŒï¼‰
MAX_RETRIES=3
BACKOFF_SECONDS=60

# æµ‹è¯•é…ç½®ï¼ˆå¯é€‰ï¼‰
ENABLE_TEST_HOOKS=true        # æ˜¯å¦æ‰§è¡Œæµ‹è¯•é’©å­
TEST_COMMAND=""               # ç•™ç©ºè¡¨ç¤ºè‡ªåŠ¨æ£€æµ‹ï¼ˆgo test, npm test ç­‰ï¼‰

# è°ƒè¯•æ¨¡å¼
DRY_RUN=false                 # ä»…ç”Ÿæˆè®¡åˆ’ï¼Œä¸æ‰§è¡Œä»£ç 
DEBUG_WORKFLOW=false          # æ‰“å°å·¥ä½œæµçŠ¶æ€æ—¥å¿—
```

### é…ç½®ä¼˜å…ˆçº§

1. **ç¯å¢ƒå˜é‡**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **`.env` æ–‡ä»¶**
3. **é»˜è®¤å€¼**ï¼ˆä»£ç ä¸­ç¡¬ç¼–ç ï¼‰

### ç™½åå•/é»‘åå•ï¼ˆå¯é€‰ï¼Œæœªæ¥æ”¯æŒï¼‰

```yaml
# .swe-agent.ymlï¼ˆä»“åº“æ ¹ç›®å½•ï¼‰
workflow:
  enabled: true
  stages:
    - clarify
    - prd
    - coding
    - review
  
  cost_limit:
    daily: 10.0      # æ¯æ—¥æˆæœ¬ä¸Šé™ï¼ˆç¾å…ƒï¼‰
    per_issue: 1.0   # å• Issue æˆæœ¬ä¸Šé™
  
  blacklist:
    files:
      - ".github/workflows/*"  # ç¦æ­¢ä¿®æ”¹ CI é…ç½®
      - "go.mod"               # ç¦æ­¢ä¿®æ”¹ä¾èµ–
    
  whitelist:
    users:
      - "owner"      # ä»… owner å¯è§¦å‘
```

## éªŒæ”¶æ ‡å‡†

### Stage 0ï¼šéœ€æ±‚æ¾„æ¸…
- [ ] ç”¨æˆ·åœ¨ Issue ä¸­å›å¤ `/clarify`
- [ ] â‰¤1 åˆ†é’Ÿï¼ŒIssue ä¸‹å‡ºç°æ¾„æ¸…é—®é¢˜åˆ—è¡¨ï¼ˆ5-10 ä¸ªé—®é¢˜ï¼‰
- [ ] ç”¨æˆ·å›ç­”é—®é¢˜åï¼Œå·¥ä½œæµçŠ¶æ€æ›´æ–°ä¸º `"clarify"`

### Stage 1ï¼šPRD ç”Ÿæˆ
- [ ] ç”¨æˆ·å›å¤ `/prd`
- [ ] â‰¤1 åˆ†é’Ÿï¼ŒIssue ä¸‹å‡ºç° PRD æ–‡æ¡£ï¼ˆMarkdown æ ¼å¼ï¼‰
- [ ] PRD åŒ…å«ï¼šèƒŒæ™¯ã€ç›®æ ‡ã€æŠ€æœ¯æ–¹æ¡ˆã€éªŒæ”¶æ ‡å‡†ã€æ–‡ä»¶å˜æ›´é¢„ä¼°
- [ ] å·¥ä½œæµçŠ¶æ€æ›´æ–°ä¸º `"prd"`

### Stage 2ï¼šä»£ç å¼€å‘
- [ ] ç”¨æˆ·å›å¤ `/code`
- [ ] â‰¤2 åˆ†é’Ÿï¼ŒIssue ä¸‹å‡ºç°å®Œæˆè¯„è®ºï¼š
  - åˆ†æ”¯é“¾æ¥ï¼š`https://github.com/{repo}/tree/{branch}`
  - **æ‰‹åŠ¨åˆ›å»º PR é“¾æ¥**ï¼ˆä¸è‡ªåŠ¨åˆ›å»º PRï¼‰
  - å˜æ›´æ–‡ä»¶åˆ—è¡¨
  - æˆæœ¬
- [ ] ä»£ç å·²æ¨é€åˆ°åˆ†æ”¯ï¼ˆ`pilot/issue-{number}`ï¼‰
- [ ] å·¥ä½œæµçŠ¶æ€æ›´æ–°ä¸º `"coding"`

### Stage 3ï¼šCode Reviewï¼ˆå¯é€‰ï¼‰
- [ ] ç”¨æˆ·åœ¨ PR è¯„è®ºä¸­å›å¤ `/code-review`
- [ ] â‰¤1 åˆ†é’Ÿï¼ŒPR ä¸‹å‡ºç° Review è¯„è®ºï¼š
  - é€šè¿‡çš„æ£€æŸ¥
  - éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼ˆå¸¦æ–‡ä»¶:è¡Œå·ï¼‰
  - å»ºè®®ï¼ˆå¯é€‰ï¼‰
  - Review æˆæœ¬
- [ ] Review ç»“æœå‡†ç¡®ï¼ˆæ— æ˜æ˜¾è¯¯åˆ¤ï¼‰

### Stage 4ï¼šä¿®å¤è¿­ä»£
- [ ] ç”¨æˆ·å›å¤ `/code fix` æˆ– `/code fix [å…·ä½“æ„è§]`
- [ ] â‰¤2 åˆ†é’Ÿï¼ŒPR åˆ†æ”¯ä¸Šå‡ºç°æ–° commit
- [ ] ä¿®å¤å†…å®¹ç¬¦åˆ Review æ„è§
- [ ] ä¿®å¤æ¬¡æ•° â‰¤3 æ¬¡ï¼ˆè¶…è¿‡æç¤ºäººå·¥ä»‹å…¥ï¼‰
- [ ] å·¥ä½œæµçŠ¶æ€æ›´æ–°ä¸º `"review"`

### é€šç”¨éªŒæ”¶
- [ ] é˜²æŠ–ï¼šåŒä¸€è¯„è®º ID 12h å†…ä¸é‡å¤æ‰§è¡Œ
- [ ] æƒé™ï¼šé App Installer æ— æ³•è§¦å‘ï¼ˆå·²å®ç°ï¼‰
- [ ] æˆæœ¬è¿½è¸ªï¼šæ¯æ¬¡è°ƒç”¨è®°å½•æˆæœ¬ï¼Œç´¯è®¡åˆ° `WorkflowState.TotalCost`
- [ ] çŠ¶æ€è¿½è¸ªï¼šæ¯ä¸ªé˜¶æ®µæ›´æ–° `CommentTracker.State.Tasks` è¿›åº¦æ¡
- [ ] é”™è¯¯å¤„ç†ï¼šå¤±è´¥æ—¶åœ¨è¯„è®ºä¸­æ˜ç¡®æç¤ºé”™è¯¯åŸå› ä¸ä¸‹ä¸€æ­¥

## ç›‘æ§ä¸æŒ‡æ ‡

### å·¥ä½œæµæŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰

```go
type WorkflowMetrics struct {
    // æˆåŠŸç‡
    TotalIssues       int     // æ€»å¤„ç† Issue æ•°
    CompletedIssues   int     // å®Œæˆçš„ Issue æ•°ï¼ˆPR å·² Mergeï¼‰
    SuccessRate       float64 // å®Œæˆç‡ = Completed / Total
    
    // é˜¶æ®µåˆ†å¸ƒ
    ClarifyStageCount int     // åœåœ¨æ¾„æ¸…é˜¶æ®µçš„ Issue æ•°
    PRDStageCount     int     // åœåœ¨ PRD é˜¶æ®µçš„ Issue æ•°
    CodingStageCount  int     // åœåœ¨å¼€å‘é˜¶æ®µçš„ Issue æ•°
    ReviewStageCount  int     // åœåœ¨å®¡æŸ¥é˜¶æ®µçš„ Issue æ•°
    
    // æ¾„æ¸…æ•ˆç‡
    AvgClarifyRounds  float64 // å¹³å‡æ¾„æ¸…è½®æ¬¡
    ClarifyAcceptRate float64 // æ¾„æ¸…åç›´æ¥è¿›å…¥ PRD çš„æ¯”ä¾‹
    
    // PRD è´¨é‡
    AvgPRDIterations  float64 // å¹³å‡ PRD ä¿®æ”¹æ¬¡æ•°
    PRDAcceptRate     float64 // ä¸€æ¬¡é€šè¿‡ç‡
    
    // ä»£ç è´¨é‡
    AvgFixAttempts    float64 // å¹³å‡ä¿®å¤æ¬¡æ•°
    FirstTimePassRate float64 // ä»£ç ä¸€æ¬¡é€šè¿‡ç‡ï¼ˆæ— éœ€ä¿®å¤ï¼‰
    
    // æˆæœ¬
    AvgCostPerIssue   float64 // å• Issue å¹³å‡æˆæœ¬ï¼ˆç¾å…ƒï¼‰
    TotalCostToday    float64 // ä»Šæ—¥æ€»æˆæœ¬
    CostByStage       map[string]float64 // å„é˜¶æ®µæˆæœ¬åˆ†å¸ƒ
    
    // è€—æ—¶
    AvgTimePerIssue   string  // å• Issue å¹³å‡è€—æ—¶ï¼ˆä» /clarify åˆ° PR Mergeï¼‰
    AvgTimeByStage    map[string]string // å„é˜¶æ®µå¹³å‡è€—æ—¶
}
```

### ç°æœ‰æŒ‡æ ‡ï¼ˆä¿ç•™ï¼‰
- ä»»åŠ¡å®Œæˆ/å¤±è´¥ç‡
- åˆ›å»º PR æˆåŠŸç‡
- Provider é”™è¯¯åˆ†å¸ƒ
- äº‹ä»¶å»é‡å‘½ä¸­ç‡

### å‘Šè­¦è§„åˆ™ï¼ˆæ–°å¢ï¼‰

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|------|----------|
| ä»Šæ—¥æ€»æˆæœ¬ | > $10 | P1ï¼ˆé«˜ï¼‰ |
| å• Issue æˆæœ¬ | > $1 | P2ï¼ˆä¸­ï¼‰ |
| æˆåŠŸç‡ | < 50% | P1ï¼ˆé«˜ï¼‰ |
| ä¿®å¤æ¬¡æ•° | > 3 æ¬¡/Issue | P2ï¼ˆä¸­ï¼‰ |
| æ¾„æ¸…è½®æ¬¡ | > 5 æ¬¡/Issue | P3ï¼ˆä½ï¼‰ |

## é‡Œç¨‹ç¢‘

### **M1ï¼ˆæœ¬å‘¨ï¼ŒP0ï¼‰ï¼šæ ¸å¿ƒå·¥ä½œæµæ‰“é€š**
- [x] åŸºç¡€è®¾æ–½ï¼ˆå·²å®Œæˆï¼‰ï¼š
  - Webhook handlerã€ä»»åŠ¡é˜Ÿåˆ—ã€æ‰§è¡Œå™¨ã€è¯„è®ºè¿½è¸ª
  - æƒé™éªŒè¯ï¼ˆApp Installerï¼‰
  - é˜²æŠ–æœºåˆ¶ï¼ˆcommentDeduperï¼‰
- [ ] å·¥ä½œæµçŠ¶æ€è¿½è¸ªï¼ˆæ–°å¢ï¼‰ï¼š
  - `taskstore/workflow.go`ï¼šWorkflowState æ•°æ®ç»“æ„
  - å†…å­˜å­˜å‚¨å®ç°
- [ ] è§¦å‘è¯è§£æï¼ˆæ–°å¢ï¼‰ï¼š
  - `/clarify`, `/prd`, `/code`, `/code-review`
  - `webhook/handler.go`ï¼šparseTriggerCommand()
- [ ] Stage 0ï¼šéœ€æ±‚æ¾„æ¸…ï¼š
  - `internal/prompt/clarify.go`ï¼šæ¾„æ¸… Prompt æ¨¡æ¿
  - è¯»å–ä»“åº“ä¸Šä¸‹æ–‡ï¼ˆREADME, ç›®å½•ç»“æ„ï¼‰
- [ ] Stage 1ï¼šPRD ç”Ÿæˆï¼š
  - `internal/prompt/prd.go`ï¼šPRD Prompt æ¨¡æ¿
  - è¯„è®ºä¸­å±•ç¤º PRDï¼ˆä¸è½ç›˜ï¼‰
- [ ] Stage 2ï¼šä»£ç å¼€å‘ï¼š
  - ä¿®æ”¹ `executor/task.go:352`ï¼šä¸è‡ªåŠ¨åˆ›å»º PR
  - è¿”å›æ‰‹åŠ¨åˆ›å»º PR é“¾æ¥
- [ ] æˆæœ¬æ§åˆ¶ï¼ˆP0ï¼‰ï¼š
  - `DAILY_CALL_LIMIT`, `PER_ISSUE_COST_LIMIT`
  - è¶…é™é˜»æ­¢æ‰§è¡Œå¹¶å‘Šè­¦
- [ ] æµ‹è¯•ï¼š
  - å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
  - é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… å®Œæ•´æµç¨‹å¯è¿è¡Œï¼šIssue â†’ /clarify â†’ /prd â†’ /code â†’ æ‰‹åŠ¨åˆ›å»º PR
- âœ… æˆæœ¬æ§åˆ¶ç”Ÿæ•ˆï¼šè¶…é™æ—¶é˜»æ­¢æ‰§è¡Œ
- âœ… å·¥ä½œæµçŠ¶æ€æ­£ç¡®è¿½è¸ª

---

### **M2ï¼ˆä¸‹å‘¨ï¼ŒP1ï¼‰ï¼šCode Review + ä¿®å¤è¿­ä»£**
- [ ] Stage 3ï¼šCode Reviewï¼š
  - `internal/prompt/review.go`ï¼šReview Prompt æ¨¡æ¿
  - è¯»å– `git diff` å¹¶å®¡æŸ¥
- [ ] Stage 4ï¼šä¿®å¤è¿­ä»£ï¼š
  - æ”¯æŒ `/code fix` è§¦å‘
  - ä¿®å¤æ¬¡æ•°é™åˆ¶ï¼ˆMAX_FIX_ATTEMPTS=3ï¼‰
  - åœ¨ç°æœ‰ PR åˆ†æ”¯ä¸Šæäº¤ï¼ˆå·²æ”¯æŒï¼‰
- [ ] å®Œæ•´ä¸Šä¸‹æ–‡è·å–ï¼š
  - `executor/task.go:550`ï¼šcomposeFullContext()
  - åŒ…å«æ¾„æ¸…ã€PRDã€è¯„è®ºå†å²
- [ ] æµ‹è¯•é’©å­ï¼ˆå¯é€‰ï¼‰ï¼š
  - è‡ªåŠ¨æ£€æµ‹æµ‹è¯•å‘½ä»¤ï¼ˆgo test, npm test ç­‰ï¼‰
  - æµ‹è¯•å¤±è´¥ â†’ é˜»æ­¢ PR åˆ›å»ºæˆ–æ ‡è®° Draft

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… Code Review å‡†ç¡®æ€§ > 80%
- âœ… ä¿®å¤è¿­ä»£æˆåŠŸç‡ > 60%
- âœ… ä¿®å¤æ¬¡æ•°æ§åˆ¶ç”Ÿæ•ˆ

---

### **M3ï¼ˆ2-3 å‘¨ï¼ŒP2ï¼‰ï¼šä½“éªŒä¼˜åŒ– + Playbook**
- [ ] æ™ºèƒ½è§¦å‘æ¨¡å¼ï¼ˆå¯é€‰ï¼‰ï¼š
  - `/code` æ ¹æ®å½“å‰ Stage è‡ªåŠ¨åˆ¤æ–­è¡Œä¸º
- [ ] PRD æ–‡ä»¶è½ç›˜ï¼ˆå¯é€‰ï¼‰ï¼š
  - è½ç›˜åˆ° `docs/prd/ISSUE-{number}.md`
  - PR æè¿°å¼•ç”¨ PRD
- [ ] å¤§éœ€æ±‚æ‹†åˆ†æç¤ºï¼š
  - æ–‡ä»¶å˜æ›´ > 8 ä¸ª â†’ æç¤ºæ‹†åˆ†
  - å¤æ‚åº¦é«˜ â†’ å»ºè®®å¤šä¸ª PR
- [ ] æ›´ç»† Playbookï¼š
  - æ–‡æ¡£è¿ç§»åœºæ™¯ï¼ˆæ›¿æ¢é“¾æ¥ã€æ›´æ–°ç¤ºä¾‹ï¼‰
  - è¯­æ³•è¿ç§»åœºæ™¯ï¼ˆAPI å‡çº§ã€åºŸå¼ƒè­¦å‘Šï¼‰
  - ç¼–è¯‘å™¨å°ä¿®ï¼ˆé”™è¯¯æ¶ˆæ¯ä¼˜åŒ–ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ç”¨æˆ·ä½“éªŒæµç•…ï¼ˆå‡å°‘æ‰‹åŠ¨æ­¥éª¤ï¼‰
- âœ… å¤§éœ€æ±‚æ‹†åˆ†å»ºè®®å‡†ç¡®æ€§ > 70%

---

### **M4ï¼ˆ1 ä¸ªæœˆï¼ŒP3ï¼‰ï¼šç›‘æ§ + é»‘ç™½åå•**
- [ ] æŒ‡æ ‡é¢æ¿ï¼š
  - å·¥ä½œæµå„é˜¶æ®µæˆåŠŸç‡
  - å¹³å‡æˆæœ¬ã€è€—æ—¶
  - æ¾„æ¸…/PRD/ä¿®å¤è´¨é‡
- [ ] å‘Šè­¦ç³»ç»Ÿï¼š
  - æˆæœ¬å‘Šè­¦ï¼ˆä»Šæ—¥æ€»æˆæœ¬ > $10ï¼‰
  - æˆåŠŸç‡å‘Šè­¦ï¼ˆ< 50%ï¼‰
- [ ] é»‘ç™½åå•ï¼š
  - æ–‡ä»¶é»‘åå•ï¼ˆç¦æ­¢ä¿®æ”¹ CI é…ç½®ï¼‰
  - ç”¨æˆ·ç™½åå•ï¼ˆä»… owner å¯è§¦å‘ï¼‰
- [ ] æ•°æ®åº“å­˜å‚¨ï¼š
  - è¿ç§» WorkflowState åˆ°æ•°æ®åº“
  - æ”¯æŒè·¨ä¼šè¯æŸ¥è¯¢

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æŒ‡æ ‡é¢æ¿å¯ç”¨
- âœ… å‘Šè­¦åŠæ—¶è§¦å‘ï¼ˆ5 åˆ†é’Ÿå†…ï¼‰

## é£é™©ä¸ç¼“è§£

### **P0 é£é™©ï¼šæˆæœ¬å¤±æ§**
**é£é™©**ï¼šè‡ªåŠ¨è§¦å‘å¯¼è‡´ AI è°ƒç”¨é‡çˆ†ç‚¸ï¼Œæœˆè´¹å¤±æ§
**å½±å“**ï¼šä¸¥é‡ï¼ˆ$100+/æœˆï¼‰
**ç¼“è§£**ï¼š
- âœ… **ç¡¬æ€§é…é¢**ï¼š`DAILY_CALL_LIMIT=100`, `PER_ISSUE_COST_LIMIT=1.0`
- âœ… **äººå·¥è§¦å‘**ï¼šæ‰€æœ‰é˜¶æ®µéƒ½éœ€è¦æ˜¾å¼è§¦å‘è¯ï¼ˆ/clarify, /prd ç­‰ï¼‰
- âœ… **ä¿®å¤æ¬¡æ•°é™åˆ¶**ï¼šæœ€å¤š 3 æ¬¡/PR
- âœ… **å‘Šè­¦æœºåˆ¶**ï¼šæˆæœ¬è¶…é™å®æ—¶å‘Šè­¦
- [ ] ä»“åº“ç™½åå•ï¼šåˆæœŸåªå¯¹ä¿¡ä»»ä»“åº“å¯ç”¨ï¼ˆM4ï¼‰

---

### **P1 é£é™©ï¼šè¯¯æ”¹ä»£ç **
**é£é™©**ï¼šAI ä¿®æ”¹å…³é”®æ–‡ä»¶ï¼ˆå¦‚ CI é…ç½®ã€ä¾èµ–æ–‡ä»¶ï¼‰å¯¼è‡´ç ´å
**å½±å“**ï¼šä¸­ç­‰ï¼ˆéœ€è¦äººå·¥å›æ»šï¼‰
**ç¼“è§£**ï¼š
- âœ… **æœ€å°å˜æ›´åŸåˆ™**ï¼šPrompt æ˜ç¡®æŒ‡ç¤º"æœ€å°æ”¹åŠ¨"
- âœ… **äººå·¥å®¡æ ¸**ï¼šä¸è‡ªåŠ¨åˆ›å»º PRï¼Œäººå·¥å®¡æ ¸åˆ†æ”¯åå†åˆ›å»º
- [ ] **æ–‡ä»¶é»‘åå•**ï¼šç¦æ­¢ä¿®æ”¹ `.github/workflows/*`, `go.mod` ç­‰ï¼ˆM4ï¼‰
- [ ] **å¤±è´¥é™çº§**ï¼šä¸¥é‡é”™è¯¯ â†’ åˆ›å»º Draft PR è€Œéæ­£å¸¸ PR

---

### **P1 é£é™©ï¼šå¾ªç¯è§¦å‘**
**é£é™©**ï¼šBot è¯„è®ºè§¦å‘æ–°çš„ webhookï¼Œå¯¼è‡´æ— é™å¾ªç¯
**å½±å“**ï¼šä¸­ç­‰ï¼ˆæˆæœ¬ç¿»å€ + GitHub API é™æµï¼‰
**ç¼“è§£**ï¼š
- âœ… **Bot è¿‡æ»¤**ï¼šå·²å®ç°ï¼ˆhandler.go:116 å¿½ç•¥ Bot è¯„è®ºï¼‰
- âœ… **äº‹ä»¶å»é‡**ï¼šå·²å®ç°ï¼ˆcommentDeduper 12h å»é‡ï¼‰
- âœ… **ä¸²è¡Œæ‰§è¡Œ**ï¼šæŒ‰ `repo#number` ä¸²è¡Œï¼Œé¿å…å¹¶å‘å†²çª

---

### **P2 é£é™©ï¼šæƒé™é—®é¢˜**
**é£é™©**ï¼šç¼ºå°‘ `gh` CLI æƒé™æˆ–ç¯å¢ƒé…ç½®é”™è¯¯
**å½±å“**ï¼šä½ï¼ˆåŠŸèƒ½ä¸å¯ç”¨ï¼Œä½†ä¸ä¼šç ´åï¼‰
**ç¼“è§£**ï¼š
- âœ… **å¯åŠ¨æ—¶æ£€æŸ¥**ï¼šæ£€æµ‹ `gh` CLI å’Œæƒé™ï¼ˆå½“å‰ï¼šè¿è¡Œæ—¶é™çº§ï¼‰
- [ ] **é…ç½®éªŒè¯**ï¼šå¯åŠ¨æ—¶éªŒè¯æ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡ï¼ˆM1ï¼‰
- âœ… **é”™è¯¯æç¤º**ï¼šå¤±è´¥æ—¶æ˜ç¡®æç¤ºé…ç½®é—®é¢˜

---

### **P2 é£é™©ï¼šè·¨ä»“åº“/è·¨è¯­è¨€å…¼å®¹æ€§**
**é£é™©**ï¼šé Go é¡¹ç›®çš„æµ‹è¯•ç­–ç•¥ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´éƒ¨åˆ†åŠŸèƒ½å¤±æ•ˆ
**å½±å“**ï¼šä¸­ç­‰ï¼ˆéƒ¨åˆ†ä»“åº“ä¸å¯ç”¨ï¼‰
**ç¼“è§£**ï¼š
- âœ… **å°½åŠ›è€Œä¸º**ï¼šæµ‹è¯•å¤±è´¥ä¸é˜»æ­¢ PR åˆ›å»ºï¼Œåªæ ‡è®°è­¦å‘Š
- [ ] **è‡ªåŠ¨æ£€æµ‹**ï¼šæ ¹æ® package.json, Cargo.toml ç­‰æ£€æµ‹é¡¹ç›®ç±»å‹ï¼ˆM2ï¼‰
- âœ… **æ˜ç¡®é”™è¯¯**ï¼šå¤±è´¥æ—¶æä¾›å¯è§è§£é‡Šä¸äººå·¥æ¥ç®¡æŒ‡å¼•

---

### **P3 é£é™©ï¼šPRD è´¨é‡ä¸ç¨³å®š**
**é£é™©**ï¼šAI ç”Ÿæˆçš„ PRD å¯èƒ½åç¦»ç”¨æˆ·æ„å›¾
**å½±å“**ï¼šä½ï¼ˆç”¨æˆ·å¯ä»¥ä¿®æ”¹åå† `/code`ï¼‰
**ç¼“è§£**ï¼š
- âœ… **æ¾„æ¸…ç¯èŠ‚**ï¼šStage 0 ç¡®ä¿éœ€æ±‚æ¸…æ™°
- âœ… **è¿­ä»£æ”¯æŒ**ï¼šç”¨æˆ·å¯ä»¥è¦æ±‚é‡æ–°ç”Ÿæˆ PRD
- [ ] **Prompt ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…æ•ˆæœè°ƒæ•´ PRD Promptï¼ˆæŒç»­ä¼˜åŒ–ï¼‰

## å¼€æ”¾é—®é¢˜

1. **æ˜¯å¦æ”¯æŒæ™ºèƒ½è§¦å‘æ¨¡å¼ï¼Ÿ**ï¼ˆM3 å†³å®šï¼‰
   - ä¼˜ç‚¹ï¼šç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œåªéœ€ä¸€ä¸ª `/code` èµ°å®Œå…¨æµç¨‹
   - ç¼ºç‚¹ï¼šè¯¯åˆ¤é£é™©ï¼Œå¯èƒ½è·³è¿‡æŸäº›é˜¶æ®µ

2. **PRD æ˜¯å¦å¿…é¡»è½ç›˜æ–‡ä»¶ï¼Ÿ**ï¼ˆM2 å†³å®šï¼‰
   - ä¼˜ç‚¹ï¼šä¾¿äºè¿½æº¯ï¼Œå¯ä»¥åœ¨ PR ä¸­å¼•ç”¨
   - ç¼ºç‚¹ï¼šå¯èƒ½ä¸ç°æœ‰æ–‡æ¡£è§„èŒƒå†²çª

3. **æ˜¯å¦é»˜è®¤å¼€å¯ Code Reviewï¼Ÿ**ï¼ˆM2 å†³å®šï¼‰
   - ä¼˜ç‚¹ï¼šè´¨é‡æ›´é«˜
   - ç¼ºç‚¹ï¼šæˆæœ¬ç¿»å€ï¼ˆæ¯ä¸ª Issue å¤š 1-2 æ¬¡ AI è°ƒç”¨ï¼‰
   - **å½“å‰å†³å®š**ï¼šé»˜è®¤å…³é—­ï¼ŒæŒ‰éœ€è§¦å‘

4. **ä¿®å¤æ¬¡æ•°é™åˆ¶æ˜¯å¦è¿‡äºä¸¥æ ¼ï¼Ÿ**ï¼ˆM2 æ ¹æ®å®é™…æ•°æ®è°ƒæ•´ï¼‰
   - å½“å‰ï¼š3 æ¬¡/PR
   - å¯èƒ½è°ƒæ•´ä¸ºï¼š5 æ¬¡/PR æˆ–æ ¹æ®å¤æ‚åº¦åŠ¨æ€è°ƒæ•´

5. **æ˜¯å¦éœ€è¦æ”¯æŒ"è‰ç¨¿ PRD"åŠŸèƒ½ï¼Ÿ**ï¼ˆM3 å†³å®šï¼‰
   - åœºæ™¯ï¼šéœ€æ±‚ä¸æ¸…æ™°æ—¶ï¼Œç”Ÿæˆè‰ç¨¿ PRD ä¾›è®¨è®º
   - å®ç°ï¼šæ–°å¢ `/prd-draft` è§¦å‘è¯

